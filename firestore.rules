rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function hasRole(role) {
      return resource.data.role == role;
    }
    
    function isStudent() {
      // Check in externalUsers collection
      return exists(/databases/$(database)/documents/externalUsers/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/externalUsers/$(request.auth.uid)).data.role == 'student';
    }
    
    function isTeacher() {
      // This is a simplified check - in reality, we'd need to check all institutions
      return false;
    }
    
    function isInstitutionAdmin() {
      // This is a simplified check - in reality, we'd need to check all institutions
      return false;
    }
    
    function isPlatformAdmin() {
      return exists(/databases/$(database)/documents/platformAdmins/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/platformAdmins/$(request.auth.uid)).data.role == 'platform_admin';
    }
    
    function sameInstitution(institutionId) {
      // Check if user belongs to the specified institution
      // This is a simplified check - in reality, we'd need to check all subcollections
      return true;
    }
    
    // Allow Firebase Functions to write data (for webhook integration)
    function isServerProcess() {
      return request.auth.token.admin == true;
    }

    // External users collection
    match /externalUsers/{userId} {
      // Users can read and write their own data
      allow read, write: if isAuthenticated() && isOwner(userId);
      
      // Users can create their own document during registration
      allow create: if isAuthenticated() && isOwner(userId);
      
      // Platform admins can read all external users
      allow read: if isAuthenticated() && isPlatformAdmin();
    }

    // Platform admins collection
    match /platformAdmins/{adminId} {
      // Platform admins can read/write their own data
      allow read, write: if isAuthenticated() && isOwner(adminId) && isPlatformAdmin();
      
      // Platform admins can read all platform admins
      allow read: if isAuthenticated() && isPlatformAdmin();
    }

    // Institutions collection
    match /institutions/{institutionId} {
      // Institution admins can read/write their own institution
      allow read, write: if isAuthenticated() && isInstitutionAdmin() && 
                         sameInstitution(institutionId);
      
      // Platform admins can read/write all institutions
      allow read, write: if isAuthenticated() && isPlatformAdmin();
      
      // Students and teachers can read their institution
      allow read: if isAuthenticated() && sameInstitution(institutionId);
      
      // Admins subcollection
      match /admins/{adminId} {
        // Institution admins can read/write their own data
        allow read, write: if isAuthenticated() && isOwner(adminId) && isInstitutionAdmin();
        
        // Institution admins can read other admins in their institution
        allow read: if isAuthenticated() && isInstitutionAdmin() && sameInstitution(institutionId);
        
        // Platform admins can read all admins
        allow read: if isAuthenticated() && isPlatformAdmin();
      }
      
      // Departments subcollection
      match /departments/{departmentId} {
        // Institution admins can read/write departments in their institution
        allow read, write: if isAuthenticated() && isInstitutionAdmin() && sameInstitution(institutionId);
        
        // Teachers and students can read departments in their institution
        allow read: if isAuthenticated() && sameInstitution(institutionId);
        
        // Platform admins can read/write all departments
        allow read, write: if isAuthenticated() && isPlatformAdmin();
        
        // Teachers subcollection
        match /teachers/{teacherId} {
          // Teachers can read/write their own data
          allow read, write: if isAuthenticated() && isOwner(teacherId) && isTeacher();
          
          // Institution admins can read teachers in their institution
          allow read: if isAuthenticated() && isInstitutionAdmin() && sameInstitution(institutionId);
          
          // Teachers can read other teachers in their institution
          allow read: if isAuthenticated() && isTeacher() && sameInstitution(institutionId);
          
          // Platform admins can read all teachers
          allow read: if isAuthenticated() && isPlatformAdmin();
        }
        
        // Students subcollection
        match /students/{studentId} {
          // Students can read/write their own data
          allow read, write: if isAuthenticated() && isOwner(studentId) && isStudent();
          
          // Teachers can read students in their department
          allow read: if isAuthenticated() && isTeacher() && sameInstitution(institutionId);
          
          // Institution admins can read students in their institution
          allow read: if isAuthenticated() && isInstitutionAdmin() && sameInstitution(institutionId);
          
          // Students can read other students in their institution
          allow read: if isAuthenticated() && isStudent() && sameInstitution(institutionId);
          
          // Platform admins can read all students
          allow read: if isAuthenticated() && isPlatformAdmin();
        }
      }
    }

    // Interview sessions collection (legacy - for backward compatibility)
    match /interview_sessions/{sessionId} {
      // Students can read/write their own sessions
      allow read, write: if isAuthenticated() && isOwner(resource.data.studentId);
      
      // Teachers can read sessions from students in their institution
      allow read: if isAuthenticated() && isTeacher() && 
                  sameInstitution(resource.data.institutionDomain);
      
      // Institution admins can read all sessions from their institution
      allow read: if isAuthenticated() && isInstitutionAdmin() && 
                  sameInstitution(resource.data.institutionDomain);
      
      // Platform admins can read all sessions
      allow read: if isAuthenticated() && isPlatformAdmin();
    }

    // Resumes collection (legacy - for backward compatibility)
    match /resumes/{resumeId} {
      // Users can read/write their own resumes
      allow read, write: if isAuthenticated() && isOwner(resource.data.userId);
      
      // Teachers can read resumes from students in their institution
      allow read: if isAuthenticated() && isTeacher() && 
                  sameInstitution(resource.data.institutionDomain);
      
      // Institution admins can read resumes from their institution
      allow read: if isAuthenticated() && isInstitutionAdmin() && 
                  sameInstitution(resource.data.institutionDomain);
    }

    // Interview feedback collection (legacy - for backward compatibility)
    match /interview_feedback/{feedbackId} {
      // Students can read their own feedback
      allow read: if isAuthenticated() && isOwner(resource.data.studentId);
      
      // AI service can write feedback
      allow write: if isAuthenticated() && isPlatformAdmin();
      
      // Teachers can read feedback from students in their institution
      allow read: if isAuthenticated() && isTeacher() && 
                  sameInstitution(resource.data.institutionDomain);
      
      // Institution admins can read feedback from their institution
      allow read: if isAuthenticated() && isInstitutionAdmin() && 
                  sameInstitution(resource.data.institutionDomain);
      
      // Firebase Functions can write feedback (for webhook integration)
      allow write: if isServerProcess();
    }

    // Session purchases collection (legacy - for backward compatibility)
    match /session_purchases/{purchaseId} {
      // Users can read/write their own purchases
      allow read, write: if isAuthenticated() && isOwner(resource.data.userId);
      
      // Institution admins can read purchases from their institution
      allow read: if isAuthenticated() && isInstitutionAdmin() && 
                  sameInstitution(resource.data.institutionDomain);
      
      // Platform admins can read all purchases
      allow read: if isAuthenticated() && isPlatformAdmin();
    }

    // Analytics collection (read-only for most users) (legacy - for backward compatibility)
    match /analytics/{doc=**} {
      // Students can read their own analytics
      allow read: if isAuthenticated() && isStudent() && 
                  isOwner(resource.data.userId);
      
      // Teachers can read analytics from their institution
      allow read: if isAuthenticated() && isTeacher() && 
                  sameInstitution(resource.data.institutionDomain);
      
      // Institution admins can read analytics from their institution
      allow read: if isAuthenticated() && isInstitutionAdmin() && 
                  sameInstitution(resource.data.institutionDomain);
      
      // Platform admins can read/write all analytics
      allow read, write: if isAuthenticated() && isPlatformAdmin();
    }

    // End of call analysis collection (legacy - for backward compatibility)
    match /end-of-call-analysis/{analysisId} {
      // Allow read for development/testing
      allow read: if true; // TODO: Restrict in production
      
      // Platform admins can read/write all analyses
      allow read, write: if isAuthenticated() && isPlatformAdmin();
      
      // Allow write for authenticated users
      allow write: if isAuthenticated();
      
      // Allow write for anonymous users (empty studentId indicates anonymous)
      allow create: if request.resource.data.studentId == '';
      
      // Allow Firebase Functions to write data (for webhook integration)
      allow create, write: if isServerProcess();
    }
    
    // Interviews collection (legacy - for backward compatibility)
    match /interviews/{interviewId} {
      // Platform admins can read/write all interviews
      allow read, write: if isAuthenticated() && isPlatformAdmin();
      
      // Students can read/write their own interviews
      allow read, write: if isAuthenticated() && isOwner(resource.data.studentId);
      
      // Allow read for development/testing
      allow read: if true; // TODO: Restrict in production
      
      // Allow write for authenticated users
      allow write: if isAuthenticated();
      
      // Allow write for anonymous users (empty studentId indicates anonymous)
      allow create: if request.resource.data.studentId == '';
      
      // Allow Firebase Functions to write data (for webhook integration)
      allow create, write: if isServerProcess();
    }

    // Institution interests collection (legacy - for backward compatibility)
    match /institution_interests/{interestId} {
      // Anyone can create institution interests (for contact form submissions)
      allow create: if true;
      
      // Platform admins can read/write all institution interests
      allow read, write: if isAuthenticated() && isPlatformAdmin();
      
      // Users cannot update or delete institution interests once created
      allow update, delete: if false;
    }

    // System configuration (platform admins only)
    match /system_config/{doc=**} {
      allow read, write: if isAuthenticated() && isPlatformAdmin();
    }

    // Scheduled price changes (platform admins only)
    match /scheduled_price_changes/{changeId} {
      allow read, write, create, update, delete: if isAuthenticated() && isPlatformAdmin();
    }

    // Metadata collection (platform admins only)
    match /metadata/{doc=**} {
      allow read, write: if isAuthenticated() && isPlatformAdmin();
    }

    // Financial analytics collection (platform admins only)
    match /financial_analytics/{doc=**} {
      allow read, write: if isAuthenticated() && isPlatformAdmin();
    }

    // Resources collection (platform admins only for now)
    match /resources/{resourceId} {
      // Platform admins can read/write all resources
      allow read, write, create, update, delete: if isAuthenticated() && isPlatformAdmin();
      
      // Institution admins can read resources
      allow read: if isAuthenticated() && isInstitutionAdmin();
      
      // Students can read resources
      allow read: if isAuthenticated() && isStudent();
    }

    // Messaging collections (platform admins only for now)
    match /messages/{messageId} {
      // Platform admins can read/write all messages
      allow read, write, create, update, delete: if isAuthenticated() && isPlatformAdmin();
      
      // Institution admins can read messages
      allow read: if isAuthenticated() && isInstitutionAdmin();
      
      // Students can read messages
      allow read: if isAuthenticated() && isStudent();
    }
    
    match /message_templates/{templateId} {
      // Platform admins can read/write all templates
      allow read, write, create, update, delete: if isAuthenticated() && isPlatformAdmin();
      
      // Institution admins can read templates
      allow read: if isAuthenticated() && isInstitutionAdmin();
    }
    
    match /broadcast_history/{historyId} {
      // Platform admins can read/write all broadcast history
      allow read, write, create, update, delete: if isAuthenticated() && isPlatformAdmin();
      
      // Institution admins can read broadcast history
      allow read: if isAuthenticated() && isInstitutionAdmin();
    }

    // Default deny all other documents
    match /{document=**} {
      allow read, write: if false;
    }
  }
}